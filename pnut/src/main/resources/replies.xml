<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace : xml을 구별하기 위한 이름 -->
<mapper namespace="repliesns">
	<resultMap type="replies" id="repliesResult">
		<result property="reply_no" column="reply_no" />
		<result property="peanut_no" column="peanut_no" />
		<result property="rep_target" column="rep_target" />
		<result property="writer" column="writer" />
		<result property="content" column="content" />
		<result property="regdate" column="regdate" />
		<result property="ip" column="ip" />
		<result property="ref" column="ref" />
		<result property="ref_level" column="ref_level" />
		<result property="del" column="del" />
	<collection property="member" resultMap="memberResult" />
	</resultMap>
	<resultMap type="member" id="memberResult">
		<result property="m_id" column="m_id" />
		<result property="m_pw" column="m_pw" />
		<result property="m_name" column="m_name" />
		<result property="m_nickname" column="m_nickname" />
		<result property="m_email" column="m_email" />
		<result property="m_tel" column="m_tel" />
		<result property="m_intro" column="m_intro" />
		<result property="m_regdate" column="m_regdate" />
		<result property="m_del" column="m_del" />
		<result property="m_profile" column="m_profile" />
		<result property="m_bg" column="m_bg" />
		<result property="re_nick" column="re_nick" />
		<result property="re_pf" column="re_pf" />
		<result property="target_nn" column="target_nn" />
	</resultMap>
	<insert id="insertReply" parameterType="replies">
		insert into pn_replies values (reply_no_seq.nextval, #{peanut_no}, #{rep_target}, #{writer}, #{content},
			sysdate, #{ip}, reply_no_seq.nextval, #{ref_level}, 'n')
	</insert>
	<insert id="insertComment" parameterType="replies">
		insert into pn_replies values (reply_no_seq.nextval, #{peanut_no}, #{rep_target}, #{writer}, #{content},
			sysdate, #{ip}, #{ref}, #{ref_level}, 'n')
	</insert>
	<select id="replyList" parameterType="hashmap" resultMap="repliesResult">
		select * from
			(select a.*, rownum rn from
				(select rep.*, mem.m_profile, mem.m_nickname, mem2.m_nickname target_nn 
				from pn_replies rep, pn_member mem, pn_member mem2
				where mem.m_id = rep.writer and rep.rep_target = mem2.m_id(+) and peanut_no = #{peanut_no}  
				order by ref desc, ref_level, reply_no) a)
			where rn between 1 and #{amt} 
	</select>
	<select id="repCnt" parameterType="integer" resultType="integer">
		select count(reply_no) from pn_replies where peanut_no = #{peanut_no}
	</select>
	<select id="repsPno" parameterType="int" resultType="integer">
		select peanut_no from pn_replies where reply_no = #{reply_no}
	</select>
	<update id="deleteReply" parameterType="hashmap">
		update pn_replies set del = 'y' where reply_no = #{reply_no} and writer = #{m_id}
	</update>
</mapper>